<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The Judgment Hall</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=UnifrakturMaguntia&family=Cinzel+Decorative:wght@700;900&family=Cinzel:wght@400;700;900&family=MedievalSharp&display=swap');

  *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

  :root {
    --ash: #0a0a0a;
    --stone: #1a1815;
    --steel: #3a3832;
    --bone: #c4b89a;
    --blood: #5a1a1a;
    --blood-bright: #8b2020;
    --gold-tarnished: #6b5a2e;
    --rust: #4a2a1a;
    --fog: rgba(20, 18, 15, 0.7);
  }

  html, body {
    width: 100%; height: 100%;
    overflow: hidden;
    background: #050505;
    font-family: 'Cinzel', serif;
    color: var(--bone);
    cursor: none;
  }

  /* CUSTOM CURSOR */
  #cursor {
    position: fixed;
    width: 24px; height: 24px;
    pointer-events: none;
    z-index: 100000;
    mix-blend-mode: difference;
    transition: transform 0.08s ease;
  }
  #cursor::before {
    content: '';
    position: absolute;
    top: 50%; left: 50%;
    width: 4px; height: 4px;
    background: var(--bone);
    border-radius: 50%;
    transform: translate(-50%, -50%);
    box-shadow: 0 0 8px rgba(196, 184, 154, 0.3);
  }
  #cursor::after {
    content: '';
    position: absolute;
    top: 50%; left: 50%;
    width: 20px; height: 20px;
    border: 1px solid rgba(196, 184, 154, 0.2);
    border-radius: 50%;
    transform: translate(-50%, -50%);
  }

  /* GLOBAL OVERLAYS */
  #grain-overlay {
    position: fixed;
    top: -50%; left: -50%;
    width: 200%; height: 200%;
    z-index: 99998;
    pointer-events: none;
    opacity: 0.08;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
    animation: grainShift 0.3s steps(3) infinite;
  }
  @keyframes grainShift {
    0% { transform: translate(0, 0); }
    33% { transform: translate(-2px, 1px); }
    66% { transform: translate(1px, -2px); }
    100% { transform: translate(-1px, 2px); }
  }

  #vignette {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    z-index: 99997;
    pointer-events: none;
    background: radial-gradient(ellipse at center, transparent 30%, rgba(0,0,0,0.6) 70%, rgba(0,0,0,0.95) 100%);
  }

  #fog-canvas {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    z-index: 99996;
    pointer-events: none;
    opacity: 0.4;
  }

  #distortion-overlay {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    z-index: 99995;
    pointer-events: none;
    opacity: 0;
    background: radial-gradient(circle at var(--dx, 50%) var(--dy, 50%), rgba(90,26,26,0.15) 0%, transparent 40%);
    transition: opacity 0.5s;
  }

  /* SCANLINES */
  #scanlines {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    z-index: 99994;
    pointer-events: none;
    background: repeating-linear-gradient(
      0deg,
      transparent,
      transparent 2px,
      rgba(0,0,0,0.03) 2px,
      rgba(0,0,0,0.03) 4px
    );
  }

  /* ========== GATE SCENE ========== */
  #gate-scene {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    z-index: 1000;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: var(--ash);
    transition: opacity 1.5s ease;
  }

  #gate-scene.destroyed {
    opacity: 0;
    pointer-events: none;
  }

  .gate-bg {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background:
      radial-gradient(ellipse at 50% 80%, rgba(90,26,26,0.08) 0%, transparent 50%),
      radial-gradient(ellipse at 50% 20%, rgba(58,56,50,0.3) 0%, transparent 60%),
      linear-gradient(180deg, #080706 0%, #0d0c0a 40%, #0a0908 100%);
  }

  .gate-texture {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    opacity: 0.04;
    background-image:
      repeating-linear-gradient(90deg, transparent, transparent 98px, rgba(196,184,154,0.1) 98px, rgba(196,184,154,0.1) 100px),
      repeating-linear-gradient(0deg, transparent, transparent 98px, rgba(196,184,154,0.05) 98px, rgba(196,184,154,0.05) 100px);
  }

  .gate-warning {
    position: relative;
    text-align: center;
    z-index: 2;
    user-select: none;
  }

  .gate-symbol {
    font-size: 3rem;
    color: var(--blood);
    opacity: 0.6;
    margin-bottom: 2rem;
    font-family: 'UnifrakturMaguntia', cursive;
    animation: symbolPulse 4s ease-in-out infinite;
    text-shadow: 0 0 20px rgba(90,26,26,0.3);
  }

  @keyframes symbolPulse {
    0%, 100% { opacity: 0.4; }
    50% { opacity: 0.7; }
  }

  .gate-title {
    font-family: 'Cinzel Decorative', serif;
    font-size: 1.6rem;
    font-weight: 900;
    letter-spacing: 0.5em;
    text-transform: uppercase;
    color: var(--bone);
    opacity: 0.7;
    margin-bottom: 1rem;
    text-shadow: 0 2px 10px rgba(0,0,0,0.8);
  }

  .gate-subtitle {
    font-family: 'Cinzel', serif;
    font-size: 0.75rem;
    letter-spacing: 0.3em;
    color: rgba(196, 184, 154, 0.3);
    margin-bottom: 4rem;
    text-transform: uppercase;
  }

  /* THE SEAL - must be held to enter */
  .gate-seal {
    position: relative;
    width: 160px;
    height: 160px;
    cursor: none;
  }

  .seal-ring {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    border: 2px solid rgba(196,184,154,0.15);
    border-radius: 50%;
    transition: border-color 0.5s;
  }

  .seal-progress {
    position: absolute;
    top: -4px; left: -4px;
    width: calc(100% + 8px);
    height: calc(100% + 8px);
  }

  .seal-progress circle {
    fill: none;
    stroke: var(--blood-bright);
    stroke-width: 2;
    stroke-dasharray: 502;
    stroke-dashoffset: 502;
    stroke-linecap: butt;
    transform: rotate(-90deg);
    transform-origin: center;
    transition: stroke-dashoffset 0.1s linear;
    filter: drop-shadow(0 0 6px rgba(139, 32, 32, 0.4));
  }

  .seal-inner {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    font-family: 'UnifrakturMaguntia', cursive;
    font-size: 2.5rem;
    color: var(--blood);
    opacity: 0.5;
    transition: opacity 0.3s, transform 0.3s;
  }

  .seal-text {
    position: absolute;
    bottom: -40px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 0.6rem;
    letter-spacing: 0.4em;
    text-transform: uppercase;
    color: rgba(196, 184, 154, 0.2);
    white-space: nowrap;
    transition: color 0.3s;
  }

  .gate-seal:hover .seal-text {
    color: rgba(196, 184, 154, 0.4);
  }

  .gate-seal.pressing .seal-inner {
    opacity: 0.8;
    transform: translate(-50%, -50%) scale(0.95);
  }

  .gate-seal.pressing .seal-ring {
    border-color: rgba(139, 32, 32, 0.3);
  }

  /* ========== JUDGMENT HALL ========== */
  #hall-scene {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    z-index: 500;
    opacity: 0;
    pointer-events: none;
    transition: opacity 2s ease;
    overflow: hidden;
  }

  #hall-scene.active {
    opacity: 1;
    pointer-events: auto;
  }

  .hall-bg {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background:
      radial-gradient(ellipse at 50% 30%, rgba(58,56,50,0.15) 0%, transparent 60%),
      radial-gradient(ellipse at 20% 80%, rgba(90,26,26,0.05) 0%, transparent 40%),
      radial-gradient(ellipse at 80% 80%, rgba(90,26,26,0.05) 0%, transparent 40%),
      linear-gradient(180deg, #0a0908 0%, #0e0d0b 50%, #080706 100%);
  }

  .hall-header {
    position: absolute;
    top: 6%;
    left: 50%;
    transform: translateX(-50%);
    text-align: center;
    z-index: 10;
  }

  .hall-title {
    font-family: 'Cinzel Decorative', serif;
    font-size: 1.8rem;
    font-weight: 900;
    letter-spacing: 0.4em;
    text-transform: uppercase;
    color: var(--bone);
    opacity: 0;
    text-shadow: 0 2px 15px rgba(0,0,0,0.8);
    animation: hallTitleReveal 3s ease forwards;
    animation-delay: 1s;
  }

  @keyframes hallTitleReveal {
    0% { opacity: 0; letter-spacing: 1em; }
    100% { opacity: 0.6; letter-spacing: 0.4em; }
  }

  .hall-divider {
    width: 200px;
    height: 1px;
    background: linear-gradient(90deg, transparent, rgba(196,184,154,0.2), transparent);
    margin: 1rem auto;
    opacity: 0;
    animation: fadeIn 2s ease forwards;
    animation-delay: 2s;
  }

  .hall-decree {
    font-size: 0.65rem;
    letter-spacing: 0.3em;
    text-transform: uppercase;
    color: rgba(196, 184, 154, 0.2);
    opacity: 0;
    animation: fadeIn 2s ease forwards;
    animation-delay: 2.5s;
  }

  @keyframes fadeIn {
    to { opacity: 1; }
  }

  /* CANDIDATES */
  .candidates-row {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    display: flex;
    gap: 100px;
    z-index: 10;
  }

  .candidate {
    position: relative;
    width: 180px;
    text-align: center;
    cursor: none;
    opacity: 0;
    transform: translateY(40px);
    transition: transform 0.6s cubic-bezier(0.23, 1, 0.32, 1);
  }

  .candidate.revealed {
    opacity: 1;
    transform: translateY(0);
  }

  .candidate-pillar {
    position: relative;
    width: 100%;
    height: 260px;
    background: linear-gradient(180deg, rgba(30,28,24,0.9) 0%, rgba(20,18,15,0.95) 100%);
    border: 1px solid rgba(196,184,154,0.06);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    transition: border-color 0.8s ease, box-shadow 0.8s ease;
  }

  .candidate-pillar::before {
    content: '';
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background:
      repeating-linear-gradient(0deg, transparent, transparent 3px, rgba(0,0,0,0.1) 3px, rgba(0,0,0,0.1) 4px);
    pointer-events: none;
  }

  .candidate-pillar::after {
    content: '';
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: radial-gradient(ellipse at 50% 0%, rgba(196,184,154,0.03) 0%, transparent 70%);
    pointer-events: none;
  }

  .candidate:hover .candidate-pillar {
    border-color: rgba(139, 32, 32, 0.2);
    box-shadow:
      0 0 40px rgba(90, 26, 26, 0.1),
      inset 0 0 30px rgba(90, 26, 26, 0.05);
  }

  .candidate-sigil {
    font-family: 'UnifrakturMaguntia', cursive;
    font-size: 4rem;
    color: var(--blood);
    opacity: 0.4;
    transition: opacity 0.5s, text-shadow 0.5s;
    text-shadow: 0 0 20px rgba(90,26,26,0.2);
  }

  .candidate:hover .candidate-sigil {
    opacity: 0.7;
    text-shadow: 0 0 30px rgba(90,26,26,0.4);
  }

  .candidate-name {
    font-family: 'Cinzel', serif;
    font-size: 0.8rem;
    font-weight: 700;
    letter-spacing: 0.3em;
    text-transform: uppercase;
    color: var(--bone);
    opacity: 0.5;
    margin-top: 1.5rem;
    transition: opacity 0.5s;
  }

  .candidate:hover .candidate-name {
    opacity: 0.8;
  }

  .candidate-epithet {
    font-size: 0.55rem;
    letter-spacing: 0.2em;
    color: rgba(196, 184, 154, 0.2);
    margin-top: 0.5rem;
    font-style: italic;
    text-transform: lowercase;
  }

  /* CANDIDATE BASE */
  .candidate-base {
    width: 140%;
    height: 8px;
    background: linear-gradient(180deg, rgba(30,28,24,0.8), rgba(10,10,10,0.9));
    border-top: 1px solid rgba(196,184,154,0.05);
    margin-top: -1px;
  }

  /* VOTE CONFIRMATION - replaces the pillar */
  .candidate.chosen .candidate-pillar {
    border-color: rgba(139, 32, 32, 0.4) !important;
    box-shadow:
      0 0 60px rgba(90, 26, 26, 0.2),
      inset 0 0 40px rgba(90, 26, 26, 0.1) !important;
  }

  .candidate.condemned .candidate-pillar {
    border-color: rgba(196,184,154,0.02) !important;
    box-shadow: none !important;
    opacity: 0.3;
  }

  /* ========== EXECUTION SCENE ========== */
  #execution-overlay {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    z-index: 2000;
    pointer-events: none;
    opacity: 0;
  }

  #execution-overlay.active {
    opacity: 1;
  }

  #sword-canvas {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    z-index: 2001;
    pointer-events: none;
  }

  /* CRACK SYSTEM */
  .crack-line {
    position: fixed;
    background: rgba(196, 184, 154, 0.1);
    z-index: 99990;
    pointer-events: none;
    transform-origin: top center;
  }

  .crack-glow {
    position: fixed;
    z-index: 99989;
    pointer-events: none;
    background: radial-gradient(ellipse, rgba(90,26,26,0.15) 0%, transparent 70%);
  }

  /* AFTERMATH */
  #aftermath-scene {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    z-index: 3000;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    opacity: 0;
    pointer-events: none;
    background: radial-gradient(ellipse at center, rgba(10,9,8,0.95) 0%, #050505 100%);
    transition: opacity 3s ease;
  }

  #aftermath-scene.active {
    opacity: 1;
    pointer-events: auto;
  }

  .aftermath-text {
    font-family: 'Cinzel Decorative', serif;
    font-size: 1.4rem;
    font-weight: 700;
    letter-spacing: 0.5em;
    text-transform: uppercase;
    color: var(--blood-bright);
    opacity: 0;
    text-shadow: 0 0 30px rgba(139, 32, 32, 0.3);
  }

  .aftermath-name {
    font-family: 'UnifrakturMaguntia', cursive;
    font-size: 3rem;
    color: var(--bone);
    opacity: 0;
    margin-top: 1rem;
    text-shadow: 0 0 20px rgba(196,184,154,0.2);
  }

  .aftermath-scar {
    width: 300px;
    height: 1px;
    background: linear-gradient(90deg, transparent, var(--blood), transparent);
    margin-top: 2rem;
    opacity: 0;
  }

  .aftermath-epitaph {
    font-size: 0.6rem;
    letter-spacing: 0.3em;
    color: rgba(196,184,154,0.15);
    margin-top: 2rem;
    opacity: 0;
    text-transform: uppercase;
  }

  /* PAGE SCAR - permanent damage */
  .page-scar {
    position: fixed;
    pointer-events: none;
    z-index: 99991;
  }

  /* SCREEN SHAKE */
  .shake-1 { animation: shake1 0.15s ease; }
  .shake-2 { animation: shake2 0.3s ease; }
  .shake-3 { animation: shake3 0.5s ease; }

  @keyframes shake1 {
    0%, 100% { transform: translate(0); }
    25% { transform: translate(-3px, 2px); }
    50% { transform: translate(2px, -3px); }
    75% { transform: translate(-2px, 1px); }
  }

  @keyframes shake2 {
    0%, 100% { transform: translate(0); }
    10% { transform: translate(-6px, 4px); }
    30% { transform: translate(5px, -6px); }
    50% { transform: translate(-4px, 3px); }
    70% { transform: translate(3px, -2px); }
    90% { transform: translate(-1px, 1px); }
  }

  @keyframes shake3 {
    0%, 100% { transform: translate(0); }
    5% { transform: translate(-10px, 6px) rotate(-0.5deg); }
    15% { transform: translate(8px, -8px) rotate(0.3deg); }
    25% { transform: translate(-6px, 4px) rotate(-0.2deg); }
    35% { transform: translate(5px, -5px) rotate(0.1deg); }
    50% { transform: translate(-3px, 2px); }
    70% { transform: translate(2px, -1px); }
  }

  /* FLASH */
  #flash-overlay {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    z-index: 99999;
    pointer-events: none;
    background: rgba(196, 184, 154, 0.1);
    opacity: 0;
  }

  /* TORCHLIGHT FLICKER on candidates */
  .torch-light {
    position: absolute;
    top: -20%;
    left: 50%;
    width: 200%;
    height: 60%;
    transform: translateX(-50%);
    background: radial-gradient(ellipse at center, rgba(107,90,46,0.04) 0%, transparent 70%);
    animation: torchFlicker 3s ease-in-out infinite alternate;
    pointer-events: none;
  }

  @keyframes torchFlicker {
    0% { opacity: 0.3; transform: translateX(-50%) scale(1); }
    20% { opacity: 0.5; }
    40% { opacity: 0.35; transform: translateX(-50%) scale(1.02); }
    60% { opacity: 0.55; }
    80% { opacity: 0.3; transform: translateX(-50%) scale(0.98); }
    100% { opacity: 0.45; transform: translateX(-50%) scale(1.01); }
  }

  /* VOTED STATE - entire page */
  body.voted {
    filter: saturate(0.6) brightness(0.85);
  }

  body.voted #hall-scene .hall-bg {
    background:
      radial-gradient(ellipse at 50% 30%, rgba(58,56,50,0.08) 0%, transparent 60%),
      linear-gradient(180deg, #080706 0%, #0a0908 50%, #060505 100%);
  }

  /* Breathing animation for the hall */
  .hall-breathing {
    animation: hallBreathe 8s ease-in-out infinite;
  }

  @keyframes hallBreathe {
    0%, 100% { filter: brightness(1); }
    50% { filter: brightness(0.95); }
  }

  /* Chain decoration */
  .chain-decor {
    position: absolute;
    width: 2px;
    background: repeating-linear-gradient(180deg, rgba(196,184,154,0.08) 0px, rgba(196,184,154,0.08) 6px, transparent 6px, transparent 12px);
    opacity: 0.5;
  }

  /* Blood drip */
  .blood-drip {
    position: fixed;
    width: 2px;
    background: linear-gradient(180deg, var(--blood-bright), transparent);
    z-index: 99992;
    pointer-events: none;
    opacity: 0;
    animation: dripFall 2s ease-in forwards;
    transform-origin: top;
  }

  @keyframes dripFall {
    0% { opacity: 0; transform: scaleY(0); }
    10% { opacity: 0.6; }
    100% { opacity: 0; transform: scaleY(1); }
  }

  /* EMBER PARTICLES */
  .ember {
    position: fixed;
    width: 3px;
    height: 3px;
    background: var(--blood-bright);
    border-radius: 50%;
    z-index: 99993;
    pointer-events: none;
    opacity: 0;
    box-shadow: 0 0 6px rgba(139,32,32,0.6);
  }

  /* CANDIDATE REVEAL SLASH */
  .reveal-slash {
    position: absolute;
    top: 50%;
    left: -10%;
    width: 120%;
    height: 2px;
    background: linear-gradient(90deg, transparent, rgba(196,184,154,0.3), rgba(196,184,154,0.5), rgba(196,184,154,0.3), transparent);
    transform: scaleX(0);
    transform-origin: left;
    z-index: 20;
    pointer-events: none;
  }

  .candidate.revealed .reveal-slash {
    animation: slashReveal 0.4s ease-out forwards;
  }

  @keyframes slashReveal {
    0% { transform: scaleX(0); opacity: 1; }
    60% { transform: scaleX(1); opacity: 0.8; }
    100% { transform: scaleX(1); opacity: 0; }
  }

  /* PERMANENT SCARS after voting */
  .scar-mark {
    position: fixed;
    pointer-events: none;
    z-index: 99988;
    opacity: 0.06;
  }

  .scar-mark.horizontal {
    width: 100%;
    height: 1px;
    background: linear-gradient(90deg, transparent 10%, rgba(139,32,32,0.3) 30%, rgba(139,32,32,0.5) 50%, rgba(139,32,32,0.3) 70%, transparent 90%);
  }

  .scar-mark.vertical {
    width: 1px;
    height: 100%;
    background: linear-gradient(180deg, transparent 10%, rgba(139,32,32,0.3) 30%, rgba(139,32,32,0.5) 50%, rgba(139,32,32,0.3) 70%, transparent 90%);
  }

  /* CHROMATIC ABERRATION on vote */
  @keyframes chromaticPulse {
    0% { text-shadow: -2px 0 rgba(139,32,32,0.5), 2px 0 rgba(90,90,140,0.3); }
    50% { text-shadow: -4px 0 rgba(139,32,32,0.3), 4px 0 rgba(90,90,140,0.2); }
    100% { text-shadow: none; }
  }

  .chromatic-hit {
    animation: chromaticPulse 0.5s ease forwards;
  }

  /* IRON DUST overlay */
  .iron-dust {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    z-index: 99987;
    pointer-events: none;
    opacity: 0;
    background:
      radial-gradient(1px 1px at 20% 30%, rgba(196,184,154,0.15) 50%, transparent 50%),
      radial-gradient(1px 1px at 40% 70%, rgba(196,184,154,0.1) 50%, transparent 50%),
      radial-gradient(1px 1px at 60% 20%, rgba(196,184,154,0.12) 50%, transparent 50%),
      radial-gradient(1px 1px at 80% 50%, rgba(196,184,154,0.08) 50%, transparent 50%),
      radial-gradient(1px 1px at 10% 80%, rgba(196,184,154,0.1) 50%, transparent 50%),
      radial-gradient(1px 1px at 90% 10%, rgba(196,184,154,0.1) 50%, transparent 50%),
      radial-gradient(2px 2px at 35% 55%, rgba(139,32,32,0.08) 50%, transparent 50%),
      radial-gradient(1px 1px at 75% 85%, rgba(196,184,154,0.12) 50%, transparent 50%);
    transition: opacity 3s ease;
  }

  body.voted .iron-dust {
    opacity: 0.4;
  }

  /* GATE CRACKS on approach */
  .gate-crack {
    position: absolute;
    background: rgba(139, 32, 32, 0.15);
    pointer-events: none;
    transform-origin: center;
    opacity: 0;
    transition: opacity 0.5s ease;
  }

  /* CANDIDATE HOVER CHAIN EFFECT */
  .candidate::before {
    content: '';
    position: absolute;
    top: -30px;
    left: 50%;
    width: 2px;
    height: 30px;
    background: repeating-linear-gradient(180deg,
      rgba(196,184,154,0.1) 0px,
      rgba(196,184,154,0.1) 4px,
      transparent 4px,
      transparent 8px
    );
    transform: translateX(-50%);
    opacity: 0.3;
    transition: height 0.6s ease, opacity 0.6s ease;
  }

  .candidate:hover::before {
    height: 50px;
    opacity: 0.6;
  }

  /* CROWN for aftermath */
  .aftermath-crown {
    font-size: 2rem;
    opacity: 0;
    margin-bottom: 1rem;
    color: var(--gold-tarnished);
    text-shadow: 0 0 15px rgba(107,90,46,0.3);
    animation: crownDescend 3s ease forwards;
    animation-delay: 0.5s;
  }

  @keyframes crownDescend {
    0% { opacity: 0; transform: translateY(-40px); }
    60% { opacity: 0.6; transform: translateY(5px); }
    80% { opacity: 0.5; transform: translateY(-2px); }
    100% { opacity: 0.4; transform: translateY(0); }
  }
</style>
</head>
<body>

<!-- CUSTOM CURSOR -->
<div id="cursor"></div>

<!-- GLOBAL OVERLAYS -->
<div id="grain-overlay"></div>
<div id="vignette"></div>
<canvas id="fog-canvas"></canvas>
<div id="distortion-overlay"></div>
<div id="scanlines"></div>
<div id="flash-overlay"></div>
<canvas id="sword-canvas"></canvas>
<div class="iron-dust"></div>

<!-- ========== GATE SCENE ========== -->
<div id="gate-scene">
  <div class="gate-bg"></div>
  <div class="gate-texture"></div>
  <div class="gate-warning">
    <div class="gate-symbol">&#x2720;</div>
    <div class="gate-title">The Judgment Hall</div>
    <div class="gate-subtitle">None shall enter without intent</div>
    <div class="gate-seal" id="gate-seal">
      <div class="seal-ring"></div>
      <svg class="seal-progress" viewBox="0 0 168 168">
        <circle cx="84" cy="84" r="80" />
      </svg>
      <div class="seal-inner">&#x2694;</div>
      <div class="seal-text">Hold to break the seal</div>
    </div>
  </div>
</div>

<!-- ========== JUDGMENT HALL ========== -->
<div id="hall-scene">
  <div class="hall-bg hall-breathing"></div>
  <div class="chain-decor" style="left: 8%; top: 0; height: 100%;"></div>
  <div class="chain-decor" style="right: 8%; top: 0; height: 100%;"></div>
  <div class="chain-decor" style="left: 15%; top: 0; height: 60%;"></div>
  <div class="chain-decor" style="right: 15%; top: 0; height: 60%;"></div>

  <div class="hall-header">
    <div class="hall-title">Choose Who Shall Be Crowned</div>
    <div class="hall-divider"></div>
    <div class="hall-decree">One must fall so another may rise</div>
  </div>

  <div class="candidates-row" id="candidates-row">
    <!-- Candidates injected by JS -->
  </div>
</div>

<!-- ========== EXECUTION OVERLAY ========== -->
<div id="execution-overlay"></div>

<!-- ========== AFTERMATH ========== -->
<div id="aftermath-scene">
  <div class="aftermath-crown" id="aftermath-crown">â™›</div>
  <div class="aftermath-text" id="aftermath-text">It is done</div>
  <div class="aftermath-name" id="aftermath-name"></div>
  <div class="aftermath-scar" id="aftermath-scar"></div>
  <div class="aftermath-epitaph" id="aftermath-epitaph">The hall remembers what you have chosen</div>
</div>

<script>
// ============================================================
// CONFIGURATION
// ============================================================
const CANDIDATES = [
  { name: 'Aldric', sigil: '&#x2694;', epithet: 'the unyielding' },
  { name: 'Morrigan', sigil: '&#x2620;', epithet: 'the forsaken' },
  { name: 'Theron', sigil: '&#x2726;', epithet: 'the hollow crown' },
  { name: 'Isolde', sigil: '&#x2740;', epithet: 'the silent blade' },
];

const HOLD_DURATION = 3000; // ms to hold gate seal
const VOTE_KEY = 'judgment_hall_vote_v1';
const FINGERPRINT_KEY = 'judgment_hall_fp_v1';

// ============================================================
// ANTI-CHEAT: Vote integrity
// ============================================================
function generateFingerprint() {
  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d');
  ctx.textBaseline = 'top';
  ctx.font = '14px Arial';
  ctx.fillText('judgment', 2, 2);
  const canvasData = canvas.toDataURL();

  const data = [
    navigator.userAgent,
    navigator.language,
    screen.width + 'x' + screen.height,
    screen.colorDepth,
    new Date().getTimezoneOffset(),
    navigator.hardwareConcurrency || 'unknown',
    canvasData.slice(-50)
  ].join('|');

  let hash = 0;
  for (let i = 0; i < data.length; i++) {
    const char = data.charCodeAt(i);
    hash = ((hash << 5) - hash) + char;
    hash = hash & hash;
  }
  return 'fp_' + Math.abs(hash).toString(36);
}

function hasVoted() {
  const vote = localStorage.getItem(VOTE_KEY);
  const fp = localStorage.getItem(FINGERPRINT_KEY);
  const sessionVote = sessionStorage.getItem(VOTE_KEY);
  return !!(vote || sessionVote || (fp && fp === generateFingerprint()));
}

function recordVote(candidateName) {
  const voteData = {
    candidate: candidateName,
    timestamp: Date.now(),
    fp: generateFingerprint()
  };
  localStorage.setItem(VOTE_KEY, JSON.stringify(voteData));
  sessionStorage.setItem(VOTE_KEY, JSON.stringify(voteData));
  localStorage.setItem(FINGERPRINT_KEY, generateFingerprint());
}

function getVoteData() {
  const raw = localStorage.getItem(VOTE_KEY);
  return raw ? JSON.parse(raw) : null;
}

// ============================================================
// AUDIO ENGINE (Web Audio API)
// ============================================================
class AudioEngine {
  constructor() {
    this.ctx = null;
    this.initialized = false;
  }

  init() {
    if (this.initialized) return;
    try {
      this.ctx = new (window.AudioContext || window.webkitAudioContext)();
      this.initialized = true;
    } catch(e) {
      console.warn('Audio not available');
    }
  }

  // Low metallic scrape
  metalScrape(duration = 1.5) {
    if (!this.ctx) return;
    const now = this.ctx.currentTime;

    const bufferSize = this.ctx.sampleRate * duration;
    const buffer = this.ctx.createBuffer(1, bufferSize, this.ctx.sampleRate);
    const data = buffer.getChannelData(0);

    for (let i = 0; i < bufferSize; i++) {
      data[i] = (Math.random() * 2 - 1) * Math.exp(-i / (bufferSize * 0.3));
    }

    const source = this.ctx.createBufferSource();
    source.buffer = buffer;

    const filter = this.ctx.createBiquadFilter();
    filter.type = 'bandpass';
    filter.frequency.value = 800;
    filter.Q.value = 5;

    const gain = this.ctx.createGain();
    gain.gain.setValueAtTime(0.06, now);
    gain.gain.exponentialRampToValueAtTime(0.001, now + duration);

    source.connect(filter);
    filter.connect(gain);
    gain.connect(this.ctx.destination);
    source.start(now);
  }

  // Deep impact
  impact(intensity = 1) {
    if (!this.ctx) return;
    const now = this.ctx.currentTime;

    const osc = this.ctx.createOscillator();
    osc.type = 'sine';
    osc.frequency.setValueAtTime(80 * intensity, now);
    osc.frequency.exponentialRampToValueAtTime(20, now + 0.8);

    const gain = this.ctx.createGain();
    gain.gain.setValueAtTime(0.3 * intensity, now);
    gain.gain.exponentialRampToValueAtTime(0.001, now + 1.2);

    // Noise burst
    const bufSize = this.ctx.sampleRate * 0.3;
    const noiseBuf = this.ctx.createBuffer(1, bufSize, this.ctx.sampleRate);
    const noiseData = noiseBuf.getChannelData(0);
    for (let i = 0; i < bufSize; i++) {
      noiseData[i] = (Math.random() * 2 - 1) * Math.exp(-i / (bufSize * 0.05));
    }
    const noiseSource = this.ctx.createBufferSource();
    noiseSource.buffer = noiseBuf;
    const noiseFilter = this.ctx.createBiquadFilter();
    noiseFilter.type = 'lowpass';
    noiseFilter.frequency.value = 400;
    const noiseGain = this.ctx.createGain();
    noiseGain.gain.setValueAtTime(0.15 * intensity, now);
    noiseGain.gain.exponentialRampToValueAtTime(0.001, now + 0.5);

    osc.connect(gain);
    gain.connect(this.ctx.destination);
    noiseSource.connect(noiseFilter);
    noiseFilter.connect(noiseGain);
    noiseGain.connect(this.ctx.destination);

    osc.start(now);
    osc.stop(now + 1.2);
    noiseSource.start(now);
  }

  // Low drone
  drone(duration = 5) {
    if (!this.ctx) return;
    const now = this.ctx.currentTime;

    const osc1 = this.ctx.createOscillator();
    osc1.type = 'sine';
    osc1.frequency.value = 40;

    const osc2 = this.ctx.createOscillator();
    osc2.type = 'sine';
    osc2.frequency.value = 41.5; // slight detune for beating

    const gain = this.ctx.createGain();
    gain.gain.setValueAtTime(0, now);
    gain.gain.linearRampToValueAtTime(0.04, now + 1);
    gain.gain.linearRampToValueAtTime(0.04, now + duration - 1.5);
    gain.gain.linearRampToValueAtTime(0, now + duration);

    osc1.connect(gain);
    osc2.connect(gain);
    gain.connect(this.ctx.destination);

    osc1.start(now);
    osc2.start(now);
    osc1.stop(now + duration);
    osc2.stop(now + duration);
  }

  // Chain rattle
  chainRattle() {
    if (!this.ctx) return;
    const now = this.ctx.currentTime;

    for (let i = 0; i < 5; i++) {
      const t = now + i * 0.08;
      const bufSize = this.ctx.sampleRate * 0.1;
      const buf = this.ctx.createBuffer(1, bufSize, this.ctx.sampleRate);
      const d = buf.getChannelData(0);
      for (let j = 0; j < bufSize; j++) {
        d[j] = (Math.random() * 2 - 1) * Math.exp(-j / (bufSize * 0.1));
      }
      const src = this.ctx.createBufferSource();
      src.buffer = buf;
      const flt = this.ctx.createBiquadFilter();
      flt.type = 'highpass';
      flt.frequency.value = 2000 + Math.random() * 3000;
      const g = this.ctx.createGain();
      g.gain.setValueAtTime(0.04, t);
      g.gain.exponentialRampToValueAtTime(0.001, t + 0.15);
      src.connect(flt);
      flt.connect(g);
      g.connect(this.ctx.destination);
      src.start(t);
    }
  }

  // Sword fall whoosh
  swordWhoosh() {
    if (!this.ctx) return;
    const now = this.ctx.currentTime;

    const bufSize = this.ctx.sampleRate * 0.6;
    const buf = this.ctx.createBuffer(1, bufSize, this.ctx.sampleRate);
    const d = buf.getChannelData(0);
    for (let i = 0; i < bufSize; i++) {
      const t = i / this.ctx.sampleRate;
      d[i] = (Math.random() * 2 - 1) * Math.sin(t * Math.PI / 0.6) * 0.8;
    }
    const src = this.ctx.createBufferSource();
    src.buffer = buf;

    const flt = this.ctx.createBiquadFilter();
    flt.type = 'bandpass';
    flt.frequency.setValueAtTime(200, now);
    flt.frequency.exponentialRampToValueAtTime(4000, now + 0.3);
    flt.frequency.exponentialRampToValueAtTime(500, now + 0.6);
    flt.Q.value = 2;

    const g = this.ctx.createGain();
    g.gain.setValueAtTime(0, now);
    g.gain.linearRampToValueAtTime(0.2, now + 0.2);
    g.gain.exponentialRampToValueAtTime(0.001, now + 0.6);

    src.connect(flt);
    flt.connect(g);
    g.connect(this.ctx.destination);
    src.start(now);
  }
}

const audio = new AudioEngine();

// ============================================================
// FOG SYSTEM (Canvas)
// ============================================================
const fogCanvas = document.getElementById('fog-canvas');
const fogCtx = fogCanvas.getContext('2d');
let fogParticles = [];
let mouseX = window.innerWidth / 2;
let mouseY = window.innerHeight / 2;

function initFog() {
  fogCanvas.width = window.innerWidth;
  fogCanvas.height = window.innerHeight;

  fogParticles = [];
  for (let i = 0; i < 40; i++) {
    fogParticles.push({
      x: Math.random() * fogCanvas.width,
      y: Math.random() * fogCanvas.height,
      radius: 80 + Math.random() * 200,
      vx: (Math.random() - 0.5) * 0.3,
      vy: (Math.random() - 0.5) * 0.15,
      opacity: 0.01 + Math.random() * 0.03,
      phase: Math.random() * Math.PI * 2
    });
  }
}

function updateFog(time) {
  fogCtx.clearRect(0, 0, fogCanvas.width, fogCanvas.height);

  for (const p of fogParticles) {
    // Mouse repulsion
    const dx = p.x - mouseX;
    const dy = p.y - mouseY;
    const dist = Math.sqrt(dx * dx + dy * dy);
    if (dist < 200) {
      const force = (200 - dist) / 200 * 0.5;
      p.x += (dx / dist) * force;
      p.y += (dy / dist) * force;
    }

    p.x += p.vx + Math.sin(time * 0.001 + p.phase) * 0.2;
    p.y += p.vy + Math.cos(time * 0.0008 + p.phase) * 0.1;

    // Wrap
    if (p.x < -p.radius) p.x = fogCanvas.width + p.radius;
    if (p.x > fogCanvas.width + p.radius) p.x = -p.radius;
    if (p.y < -p.radius) p.y = fogCanvas.height + p.radius;
    if (p.y > fogCanvas.height + p.radius) p.y = -p.radius;

    const grad = fogCtx.createRadialGradient(p.x, p.y, 0, p.x, p.y, p.radius);
    const flickerOpacity = p.opacity * (0.7 + 0.3 * Math.sin(time * 0.002 + p.phase));
    grad.addColorStop(0, `rgba(180, 170, 150, ${flickerOpacity})`);
    grad.addColorStop(0.5, `rgba(140, 130, 120, ${flickerOpacity * 0.5})`);
    grad.addColorStop(1, 'rgba(100, 90, 80, 0)');

    fogCtx.fillStyle = grad;
    fogCtx.fillRect(p.x - p.radius, p.y - p.radius, p.radius * 2, p.radius * 2);
  }
}

// ============================================================
// SWORD CANVAS SYSTEM
// ============================================================
const swordCanvas = document.getElementById('sword-canvas');
const swordCtx = swordCanvas.getContext('2d');

function initSwordCanvas() {
  swordCanvas.width = window.innerWidth;
  swordCanvas.height = window.innerHeight;
}

function drawSword(progress, targetX) {
  swordCtx.clearRect(0, 0, swordCanvas.width, swordCanvas.height);

  const cx = targetX || swordCanvas.width / 2;
  const swordLength = swordCanvas.height * 0.6;
  const swordWidth = 14;

  // Sword descends from above
  const tipY = -swordLength + progress * (swordCanvas.height * 0.55 + swordLength);
  const handleY = tipY - swordLength;

  // Blade
  swordCtx.save();
  swordCtx.strokeStyle = 'rgba(160, 155, 140, 0.8)';
  swordCtx.lineWidth = swordWidth;
  swordCtx.lineCap = 'butt';
  swordCtx.shadowColor = 'rgba(196, 184, 154, 0.3)';
  swordCtx.shadowBlur = 20;

  swordCtx.beginPath();
  swordCtx.moveTo(cx, handleY);
  swordCtx.lineTo(cx, tipY);
  swordCtx.stroke();

  // Blade edge highlight
  swordCtx.strokeStyle = 'rgba(220, 215, 200, 0.4)';
  swordCtx.lineWidth = 2;
  swordCtx.beginPath();
  swordCtx.moveTo(cx, handleY);
  swordCtx.lineTo(cx, tipY);
  swordCtx.stroke();

  // Crossguard
  const guardY = handleY + swordLength * 0.15;
  swordCtx.strokeStyle = 'rgba(107, 90, 46, 0.7)';
  swordCtx.lineWidth = 8;
  swordCtx.beginPath();
  swordCtx.moveTo(cx - 40, guardY);
  swordCtx.lineTo(cx + 40, guardY);
  swordCtx.stroke();

  // Handle wrap
  swordCtx.strokeStyle = 'rgba(74, 42, 26, 0.6)';
  swordCtx.lineWidth = swordWidth + 4;
  swordCtx.beginPath();
  swordCtx.moveTo(cx, handleY);
  swordCtx.lineTo(cx, guardY);
  swordCtx.stroke();

  // Pommel
  swordCtx.fillStyle = 'rgba(107, 90, 46, 0.6)';
  swordCtx.beginPath();
  swordCtx.arc(cx, handleY - 5, 10, 0, Math.PI * 2);
  swordCtx.fill();

  // Tip point
  swordCtx.fillStyle = 'rgba(200, 195, 180, 0.9)';
  swordCtx.beginPath();
  swordCtx.moveTo(cx - swordWidth/2, tipY);
  swordCtx.lineTo(cx, tipY + 20);
  swordCtx.lineTo(cx + swordWidth/2, tipY);
  swordCtx.closePath();
  swordCtx.fill();

  swordCtx.restore();
}

function clearSword() {
  swordCtx.clearRect(0, 0, swordCanvas.width, swordCanvas.height);
}

// ============================================================
// CRACK SYSTEM
// ============================================================
function createCrack(originX, originY) {
  const numBranches = 3 + Math.floor(Math.random() * 4);

  for (let b = 0; b < numBranches; b++) {
    const angle = (Math.PI * 2 / numBranches) * b + (Math.random() - 0.5) * 0.8;
    const length = 100 + Math.random() * 300;
    const segments = 5 + Math.floor(Math.random() * 8);

    let x = originX;
    let y = originY;

    for (let s = 0; s < segments; s++) {
      const segLen = length / segments;
      const segAngle = angle + (Math.random() - 0.5) * 0.6;
      const endX = x + Math.cos(segAngle) * segLen;
      const endY = y + Math.sin(segAngle) * segLen;

      const crack = document.createElement('div');
      crack.className = 'crack-line';
      const dx = endX - x;
      const dy = endY - y;
      const segActualLen = Math.sqrt(dx*dx + dy*dy);
      const segActualAngle = Math.atan2(dy, dx);

      crack.style.left = x + 'px';
      crack.style.top = y + 'px';
      crack.style.width = segActualLen + 'px';
      crack.style.height = (1 + Math.random() * 2) + 'px';
      crack.style.transformOrigin = '0 0';
      crack.style.transform = `rotate(${segActualAngle}rad)`;
      crack.style.opacity = 0.1 + Math.random() * 0.15;

      document.body.appendChild(crack);

      // Animate in with delay
      crack.style.transition = `opacity 0.3s ease ${s * 0.05}s`;
      requestAnimationFrame(() => {
        crack.style.opacity = String(0.05 + Math.random() * 0.1);
      });

      x = endX;
      y = endY;
    }
  }

  // Add glow at origin
  const glow = document.createElement('div');
  glow.className = 'crack-glow';
  glow.style.left = (originX - 50) + 'px';
  glow.style.top = (originY - 50) + 'px';
  glow.style.width = '100px';
  glow.style.height = '100px';
  document.body.appendChild(glow);
}

// ============================================================
// SCREEN EFFECTS
// ============================================================
function screenShake(level = 1) {
  document.body.classList.remove('shake-1', 'shake-2', 'shake-3');
  void document.body.offsetWidth;
  document.body.classList.add(`shake-${Math.min(level, 3)}`);
  setTimeout(() => document.body.classList.remove(`shake-${Math.min(level, 3)}`), 600);
}

function screenFlash(duration = 150, opacity = 0.15) {
  const flash = document.getElementById('flash-overlay');
  flash.style.opacity = opacity;
  setTimeout(() => { flash.style.opacity = 0; }, duration);
}

function bloodDrip(x) {
  const drip = document.createElement('div');
  drip.className = 'blood-drip';
  drip.style.left = x + 'px';
  drip.style.top = '0px';
  drip.style.height = (100 + Math.random() * 300) + 'px';
  document.body.appendChild(drip);
  setTimeout(() => drip.remove(), 3000);
}

function spawnEmbers(originX, originY, count = 15) {
  for (let i = 0; i < count; i++) {
    const ember = document.createElement('div');
    ember.className = 'ember';
    ember.style.left = originX + 'px';
    ember.style.top = originY + 'px';

    const angle = Math.random() * Math.PI * 2;
    const velocity = 2 + Math.random() * 5;
    const vx = Math.cos(angle) * velocity;
    const vy = Math.sin(angle) * velocity - 3; // upward bias
    const life = 800 + Math.random() * 1200;
    const startTime = performance.now();

    document.body.appendChild(ember);

    function animateEmber(now) {
      const elapsed = now - startTime;
      const progress = elapsed / life;
      if (progress >= 1) {
        ember.remove();
        return;
      }

      const x = originX + vx * elapsed * 0.05;
      const y = originY + vy * elapsed * 0.05 + 0.5 * 0.001 * elapsed * elapsed; // gravity
      ember.style.left = x + 'px';
      ember.style.top = y + 'px';
      ember.style.opacity = Math.max(0, 0.8 * (1 - progress));
      ember.style.transform = `scale(${1 - progress * 0.5})`;

      requestAnimationFrame(animateEmber);
    }

    setTimeout(() => requestAnimationFrame(animateEmber), i * 30);
  }
}

function createPermanentScars() {
  // Horizontal scars
  for (let i = 0; i < 3; i++) {
    const scar = document.createElement('div');
    scar.className = 'scar-mark horizontal';
    scar.style.top = (20 + Math.random() * 60) + '%';
    scar.style.left = '0';
    document.body.appendChild(scar);
  }
  // Vertical scars
  for (let i = 0; i < 2; i++) {
    const scar = document.createElement('div');
    scar.className = 'scar-mark vertical';
    scar.style.left = (20 + Math.random() * 60) + '%';
    scar.style.top = '0';
    document.body.appendChild(scar);
  }
}

// ============================================================
// CURSOR
// ============================================================
document.addEventListener('mousemove', (e) => {
  const cursor = document.getElementById('cursor');
  cursor.style.left = e.clientX + 'px';
  cursor.style.top = e.clientY + 'px';
  mouseX = e.clientX;
  mouseY = e.clientY;

  // Distortion follows cursor subtly
  const distortion = document.getElementById('distortion-overlay');
  distortion.style.setProperty('--dx', e.clientX / window.innerWidth * 100 + '%');
  distortion.style.setProperty('--dy', e.clientY / window.innerHeight * 100 + '%');
});

// ============================================================
// GATE SYSTEM
// ============================================================
let gateHoldTimer = null;
let gateProgress = 0;
let gateOpen = false;

function initGate() {
  const seal = document.getElementById('gate-seal');
  const circle = seal.querySelector('.seal-progress circle');
  const totalLen = 502;

  const startHold = (e) => {
    if (gateOpen) return;
    e.preventDefault();
    audio.init();
    audio.metalScrape(3);
    seal.classList.add('pressing');

    gateHoldTimer = setInterval(() => {
      gateProgress += 100 / (HOLD_DURATION / 16);
      if (gateProgress > 100) gateProgress = 100;
      circle.style.strokeDashoffset = totalLen - (totalLen * gateProgress / 100);

      // Shake as we get closer
      if (gateProgress > 60 && Math.random() > 0.8) {
        screenShake(1);
      }
      if (gateProgress > 85 && Math.random() > 0.7) {
        screenShake(2);
      }

      // Distortion increases
      const distortion = document.getElementById('distortion-overlay');
      distortion.style.opacity = gateProgress / 200;

      // Gate cracks appear at thresholds
      if (gateProgress > 40 && gateProgress < 42) {
        const gc = document.createElement('div');
        gc.className = 'gate-crack';
        gc.style.left = (40 + Math.random() * 20) + '%';
        gc.style.top = (30 + Math.random() * 40) + '%';
        gc.style.width = (40 + Math.random() * 60) + 'px';
        gc.style.height = '1px';
        gc.style.transform = `rotate(${(Math.random() - 0.5) * 40}deg)`;
        gc.style.opacity = '0.3';
        document.getElementById('gate-scene').appendChild(gc);
      }
      if (gateProgress > 70 && gateProgress < 72) {
        for (let gc_i = 0; gc_i < 3; gc_i++) {
          const gc = document.createElement('div');
          gc.className = 'gate-crack';
          gc.style.left = (30 + Math.random() * 40) + '%';
          gc.style.top = (20 + Math.random() * 60) + '%';
          gc.style.width = (50 + Math.random() * 100) + 'px';
          gc.style.height = (1 + Math.random()) + 'px';
          gc.style.transform = `rotate(${(Math.random() - 0.5) * 60}deg)`;
          gc.style.opacity = '0.4';
          document.getElementById('gate-scene').appendChild(gc);
        }
        audio.chainRattle();
      }

      if (gateProgress >= 100) {
        clearInterval(gateHoldTimer);
        openGate();
      }
    }, 16);
  };

  const endHold = () => {
    if (gateOpen) return;
    clearInterval(gateHoldTimer);
    seal.classList.remove('pressing');

    // Decay progress
    const decay = setInterval(() => {
      gateProgress -= 2;
      if (gateProgress <= 0) {
        gateProgress = 0;
        clearInterval(decay);
      }
      circle.style.strokeDashoffset = totalLen - (totalLen * gateProgress / 100);
    }, 16);
  };

  seal.addEventListener('mousedown', startHold);
  seal.addEventListener('touchstart', startHold);
  document.addEventListener('mouseup', endHold);
  document.addEventListener('touchend', endHold);
}

function openGate() {
  gateOpen = true;
  audio.impact(1.5);
  audio.chainRattle();
  screenShake(3);
  screenFlash(300, 0.2);

  setTimeout(() => {
    audio.drone(8);
  }, 500);

  const gate = document.getElementById('gate-scene');
  gate.classList.add('destroyed');

  setTimeout(() => {
    gate.style.display = 'none';
    enterHall();
  }, 1500);
}

// ============================================================
// JUDGMENT HALL
// ============================================================
function enterHall() {
  const hall = document.getElementById('hall-scene');
  hall.classList.add('active');

  // Render candidates
  const row = document.getElementById('candidates-row');
  row.innerHTML = '';

  CANDIDATES.forEach((c, i) => {
    const el = document.createElement('div');
    el.className = 'candidate';
    el.dataset.index = i;
    el.dataset.name = c.name;
    el.innerHTML = `
      <div class="candidate-pillar">
        <div class="torch-light"></div>
        <div class="candidate-sigil">${c.sigil}</div>
        <div class="candidate-name">${c.name}</div>
        <div class="candidate-epithet">${c.epithet}</div>
      </div>
      <div class="reveal-slash"></div>
      <div class="candidate-base"></div>
    `;
    row.appendChild(el);

    // Staggered reveal
    setTimeout(() => {
      el.classList.add('revealed');
      audio.init();
      if (i > 0) audio.metalScrape(0.5);
    }, 1500 + i * 600);

    // Vote on click
    el.addEventListener('click', () => {
      if (hasVoted()) return;
      executeVote(c, el, i);
    });

    // Hover sounds
    el.addEventListener('mouseenter', () => {
      audio.init();
      // Subtle chain on hover
      const ctx = audio.ctx;
      if (!ctx) return;
      const now = ctx.currentTime;
      const osc = ctx.createOscillator();
      osc.type = 'sine';
      osc.frequency.value = 60;
      const g = ctx.createGain();
      g.gain.setValueAtTime(0.02, now);
      g.gain.exponentialRampToValueAtTime(0.001, now + 0.3);
      osc.connect(g);
      g.connect(ctx.destination);
      osc.start(now);
      osc.stop(now + 0.3);
    });
  });

  // If already voted, show aftermath immediately
  if (hasVoted()) {
    setTimeout(() => showPreviousVote(), 2000);
  }
}

// ============================================================
// EXECUTION
// ============================================================
function executeVote(candidate, element, index) {
  recordVote(candidate.name);

  const allCandidates = document.querySelectorAll('.candidate');

  // Phase 1: Mark chosen
  element.classList.add('chosen');
  allCandidates.forEach(c => {
    if (c !== element) c.classList.add('condemned');
  });

  audio.swordWhoosh();

  // Phase 2: Sword descent animation
  const targetRect = element.getBoundingClientRect();
  const targetX = targetRect.left + targetRect.width / 2;

  let swordProgress = 0;
  const swordDuration = 800;
  const swordStart = performance.now();

  initSwordCanvas();

  function animateSword(now) {
    const elapsed = now - swordStart;
    // Easing: accelerating fall (gravity)
    swordProgress = Math.min(1, Math.pow(elapsed / swordDuration, 2.2));

    drawSword(swordProgress, targetX);

    if (swordProgress < 1) {
      requestAnimationFrame(animateSword);
    } else {
      // IMPACT
      onSwordImpact(targetX, candidate, element);
    }
  }

  setTimeout(() => {
    requestAnimationFrame(animateSword);
  }, 400);
}

function onSwordImpact(impactX, candidate, element) {
  // Massive impact
  audio.impact(2);
  screenShake(3);
  screenFlash(100, 0.3);

  // Create cracks at impact point
  const impactY = window.innerHeight * 0.55;
  createCrack(impactX, impactY);

  // EMBERS burst from impact
  spawnEmbers(impactX, impactY, 25);

  // Blood drips
  for (let i = 0; i < 5; i++) {
    setTimeout(() => {
      bloodDrip(impactX - 50 + Math.random() * 100);
    }, i * 200);
  }

  // Second impact wave
  setTimeout(() => {
    audio.impact(1);
    screenShake(2);
    createCrack(impactX - 100 + Math.random() * 200, impactY + Math.random() * 100);
    spawnEmbers(impactX + (Math.random() - 0.5) * 100, impactY + Math.random() * 50, 12);
  }, 300);

  // Chain sound
  setTimeout(() => {
    audio.chainRattle();
  }, 500);

  // Third wave - more cracks spreading
  setTimeout(() => {
    screenShake(1);
    createCrack(
      window.innerWidth * (0.2 + Math.random() * 0.6),
      window.innerHeight * (0.3 + Math.random() * 0.4)
    );
  }, 700);

  // Permanent scars
  setTimeout(() => {
    createPermanentScars();
  }, 1000);

  // Clear sword and transition to aftermath
  setTimeout(() => {
    clearSword();
    audio.drone(10);
  }, 1500);

  setTimeout(() => {
    showAftermath(candidate);
  }, 2500);
}

// ============================================================
// AFTERMATH
// ============================================================
function showAftermath(candidate) {
  document.body.classList.add('voted');

  const scene = document.getElementById('aftermath-scene');
  const text = document.getElementById('aftermath-text');
  const name = document.getElementById('aftermath-name');
  const scar = document.getElementById('aftermath-scar');
  const epitaph = document.getElementById('aftermath-epitaph');

  name.textContent = candidate.name;
  scene.classList.add('active');

  // Staggered reveal
  setTimeout(() => {
    text.style.transition = 'opacity 2s ease';
    text.style.opacity = '0.7';
  }, 1000);

  setTimeout(() => {
    name.style.transition = 'opacity 2s ease';
    name.style.opacity = '0.8';
  }, 2500);

  setTimeout(() => {
    scar.style.transition = 'opacity 1.5s ease';
    scar.style.opacity = '0.5';
  }, 4000);

  setTimeout(() => {
    epitaph.style.transition = 'opacity 2s ease';
    epitaph.style.opacity = '1';
  }, 5500);
}

function showPreviousVote() {
  const data = getVoteData();
  if (!data) return;

  document.body.classList.add('voted');

  const candidate = CANDIDATES.find(c => c.name === data.candidate) || { name: data.candidate };

  // Mark the chosen one
  const allCandidates = document.querySelectorAll('.candidate');
  allCandidates.forEach(c => {
    if (c.dataset.name === data.candidate) {
      c.classList.add('chosen');
    } else {
      c.classList.add('condemned');
    }
  });

  // Show scars
  const cx = window.innerWidth / 2;
  const cy = window.innerHeight / 2;
  createCrack(cx, cy);

  // Show aftermath after a moment
  setTimeout(() => {
    const scene = document.getElementById('aftermath-scene');
    const text = document.getElementById('aftermath-text');
    const name = document.getElementById('aftermath-name');
    const scar = document.getElementById('aftermath-scar');
    const epitaph = document.getElementById('aftermath-epitaph');

    text.textContent = 'Your judgment stands';
    name.textContent = candidate.name;
    epitaph.textContent = 'The hall bears your scar â€” there is no return';

    scene.classList.add('active');

    text.style.transition = 'opacity 2s ease';
    text.style.opacity = '0.7';

    setTimeout(() => {
      name.style.transition = 'opacity 2s ease';
      name.style.opacity = '0.8';
    }, 1000);

    setTimeout(() => {
      scar.style.transition = 'opacity 1.5s ease';
      scar.style.opacity = '0.5';
    }, 2000);

    setTimeout(() => {
      epitaph.style.transition = 'opacity 2s ease';
      epitaph.style.opacity = '1';
    }, 3000);
  }, 2000);
}

// ============================================================
// MAIN LOOP
// ============================================================
let lastTime = 0;
let ambientTimer = 0;

function mainLoop(time) {
  const delta = time - lastTime;
  lastTime = time;

  updateFog(time);

  // Ambient distortion pulses
  ambientTimer += delta;
  if (ambientTimer > 5000 + Math.random() * 10000) {
    ambientTimer = 0;
    const distortion = document.getElementById('distortion-overlay');
    distortion.style.opacity = '0.3';
    setTimeout(() => {
      distortion.style.opacity = '0';
    }, 2000 + Math.random() * 3000);

    // Random ambient sounds
    if (audio.initialized && Math.random() > 0.6) {
      const roll = Math.random();
      if (roll < 0.3) {
        // Distant metal creak
        audio.metalScrape(0.3);
      } else if (roll < 0.5) {
        // Wind-like whisper
        const ctx = audio.ctx;
        if (ctx) {
          const now = ctx.currentTime;
          const bufSize = ctx.sampleRate * 2;
          const buf = ctx.createBuffer(1, bufSize, ctx.sampleRate);
          const d = buf.getChannelData(0);
          for (let i = 0; i < bufSize; i++) {
            d[i] = (Math.random() * 2 - 1) * Math.sin(i / bufSize * Math.PI);
          }
          const src = ctx.createBufferSource();
          src.buffer = buf;
          const flt = ctx.createBiquadFilter();
          flt.type = 'bandpass';
          flt.frequency.value = 300 + Math.random() * 200;
          flt.Q.value = 10;
          const g = ctx.createGain();
          g.gain.setValueAtTime(0, now);
          g.gain.linearRampToValueAtTime(0.015, now + 0.5);
          g.gain.linearRampToValueAtTime(0, now + 2);
          src.connect(flt);
          flt.connect(g);
          g.connect(ctx.destination);
          src.start(now);
        }
      }
    }
  }

  // Subtle random screen flicker (very rare)
  if (Math.random() > 0.998) {
    const flash = document.getElementById('flash-overlay');
    flash.style.opacity = '0.02';
    setTimeout(() => { flash.style.opacity = '0'; }, 50);
  }

  requestAnimationFrame(mainLoop);
}

// ============================================================
// INITIALIZATION
// ============================================================
window.addEventListener('resize', () => {
  fogCanvas.width = window.innerWidth;
  fogCanvas.height = window.innerHeight;
  swordCanvas.width = window.innerWidth;
  swordCanvas.height = window.innerHeight;
});

function init() {
  initFog();
  initSwordCanvas();
  initGate();

  // If already voted, skip gate
  if (hasVoted()) {
    const gate = document.getElementById('gate-scene');
    gate.style.display = 'none';
    enterHall();
  }

  requestAnimationFrame(mainLoop);
}

document.addEventListener('DOMContentLoaded', init);

// Prevent right-click (minor anti-cheat)
document.addEventListener('contextmenu', e => e.preventDefault());

// Disable dev tools shortcuts (deterrent only)
document.addEventListener('keydown', (e) => {
  if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'J'))) {
    e.preventDefault();
  }
});
</script>
</body>
</html>
